<html>
<head>
	<title>C-Word</title>
    <script src="http://fb.me/react-with-addons-0.12.2.js"></script>
    <script src="http://fb.me/JSXTransformer-0.12.2.js"></script>
    <script src="http://code.jquery.com/jquery-1.10.0.min.js"></script>
    <script src="http://underscorejs.org/underscore-min.js"/></script>
    <script src="https://cdn.socket.io/socket.io-1.2.0.js"></script>
    <script src="prepModel.js"></script>
    <link href='http://fonts.googleapis.com/css?family=Raleway' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="style.css" />
</head>
<body>
    <div id="content"></div>
    <script type="text/jsx">
        var socket = io();

        var Puzzle = React.createClass({
            getInitialState: function() {
                return {
                    curClue:this.props.puzzle.clues.across[0]
                };
            },
            setCurClue:function(newClue){
                this.setState({curClue:newClue});

            },
            render:function(){
                return(
                    <div className="puzzle">
                        <h6>{this.props.puzzle.title}</h6>
                        <PuzzleBoard 
                            onClueChange={this.setCurClue}
                            curClue={this.state.curClue} 
                            puzzle={this.props.puzzle}/>
                        <ClueBoard curClue={this.state.curClue} clues={this.props.puzzle.clues}/>
                    </div>
                )
            }
        });

        var ClueBoard = React.createClass({
            render:function(){
                return(
                    <div className="clueboard">
                        <small>{this.props.curClue.cluenum} {this.props.curClue.dir}</small><br/>{this.props.curClue.cluestr}
                    </div>
                )
            }
        });

    	var PuzzleBoard = React.createClass({
    		getInitialState: function() {
                _this = this;
                socket.on('opUpdate', function(update){
                    _this.refs['t'+(update[0]-1)].setState({opAnswer:true});
                });
                $('html').keyup(function(e){
                    switch(e.keyCode){
                        case 8: _this.clearCurTile(); break;
                        case 9: _this.moveFocusNextWord(); break;
                        case 40: _this.moveFocusDown(); break;
                        case 38: _this.moveFocusUp(); break;
                        case 37: _this.moveFocusLeft(); break;
                        case 39: _this.moveFocusRight(); break;
                    }
                });
				return {
                    focusedTile:this.refs['t'+this.props.puzzle.clues.across[0].tiles[0]],
                    isVertical:false
                };
			},
            clearCurTile:function(){
                this.state.focusedTile.clearValue();
                this.state.isVertical?this.moveFocusUp():this.moveFocusLeft();
            },
            moveFocusNextWord:function(){
                // var newFocus = this.nextWord(this.state.focusedTile);
                // this.props.onClueChange(newFocus.props.gridnum.clues[(this.state.isVertical?1:0)]);
                // this.setState({newFocus:nextWordTile});
                // newFocus.setFocus();
            },
            moveFocusUp:function(){
                var newFocus = this.refs['t'+(this.state.focusedTile.props.keya-15)];
                this.props.onClueChange(newFocus.props.gridnum.clues[(this.state.isVertical?1:0)]);
                this.setState({focusedTile:newFocus});
                newFocus.setFocus(this.moveFocusUp);
            },
            moveFocusDown:function(){
                var newFocus = this.refs['t'+(this.state.focusedTile.props.keya+15)];
                this.props.onClueChange(newFocus.props.gridnum.clues[(this.state.isVertical?1:0)]);
                this.setState({focusedTile:newFocus});
                newFocus.setFocus(this.moveFocusDown);
            },
            moveFocusLeft:function(){
                var newFocus = this.refs['t'+(this.state.focusedTile.props.keya-1)];
                this.props.onClueChange(newFocus.props.gridnum.clues[(this.state.isVertical?1:0)]);
                this.setState({focusedTile:newFocus});
                newFocus.setFocus(this.moveFocusLeft);
            },
            moveFocusRight:function(){
                var newFocus = this.refs['t'+(this.state.focusedTile.props.keya+1)];
                this.props.onClueChange(newFocus.props.gridnum.clues[(this.state.isVertical?1:0)]);
                this.setState({focusedTile:newFocus});
                newFocus.setFocus(this.moveFocusRight);
            },
            sendPlayerAnswer:function(){
            },
            nextTile:function(tile){
                var next = this.refs['t'+(tile.props.keya+(this.state.isVertical?15:1))];
                while(next && next.state.playerAnswer!==" "){
                    if(next.state.playerAnswer==='.') next = this.nextWord(next);
                    else next = this.nextTile(next);
                }
                if(!next) next = this.nextWord(tile);
                if(!next) next = this.refs['t'+this.props.puzzle.clues.across[0].tiles[0]];
                return next;
            },
            nextWord:function(tile){
                var curClues = this.props.puzzle.clues[this.state.isVertical?'down':'across'];
                var nextClueKey = this.props.curClue.key+1;
                return this.refs['t'+curClues[nextClueKey].tiles[0]];
            },
			autoForwardFocus: function(){
				var newFocus = this.nextTile(this.state.focusedTile);
                this.props.onClueChange(newFocus.props.gridnum.clues[(this.state.isVertical?1:0)]);
                this.setState({focusedTile:newFocus});
    			newFocus.setFocus();
			},
            onTileClick:function(clickedTile){
                if(this.state.focusedTile===clickedTile){
                    this.setState({isVertical:!this.state.isVertical});
                }
                this.props.onClueChange(clickedTile.props.gridnum.clues[(this.state.isVertical?1:0)]);
                this.setState({focusedTile:clickedTile});
            },
    		render:function(){
    			var n=-1;
                var isClueStart;
                var _this = this;
    			var tiles = _.zip(this.props.puzzle.initialBoardState,this.props.puzzle.gridnums).map(function(tile){
    				n++;
                    isClueStart = tile[1].gridnum!="0";
                    tile[1].gridnum=isClueStart?tile[1].gridnum:'';
                    var highlighted = _.contains(_this.props.curClue.tiles,n);
                    if(tile[0]!=='.'){return(
    					<Tile ref={'t'+n} 
                            keya={n}
                            highlighted={highlighted}
                            initial={tile[0]}
                            isClueStart={isClueStart}
                            gridnum={tile[1]} 
                            onLetterChange={_this.autoForwardFocus}
                            onTileClick={_this.onTileClick}/>
    				);}
    				else return(
                        <BlackTile ref={'t'+n} 
                            keya={n}
                            onSetFocus={_this.moveFocusRight}/>);
    			});
    			return (
    				<div className="puzzleBoard">
    					{tiles}
    				</div>
    			)
    		}
    	});

    	var BlackTile = React.createClass({
            getInitialState: function() {
                return {playerAnswer:'.'};
            },
            setFocus:function(callAgain){
                callAgain();
            },
    		render:function(){
    			return(
    				<div className="tile black"></div>
    			);
    		}
    	});

    	var Tile = React.createClass({
    		getInitialState: function() {
				return {playerAnswer:this.props.initial, opAnswer:false};
			},
            clearValue:function(){
                this.refs.tileInput.getDOMNode().value = '';
            },
    		handleChange:function(event){
                var val = event.target.value || ' ';
    			this.setState({playerAnswer:val.toUpperCase()}, function(){
                    socket.emit('playerAnswer', [this.props.keya+1,this.state.playerAnswer]);
                    if(val!=' ') this.props.onLetterChange.call();
                });
    		},
    		setFocus:function(){
    			if(this.refs.tileInput.getDOMNode()!=document.activeElement){
                    this.refs.tileInput.getDOMNode().focus();
                    this.refs.tileInput.getDOMNode().select();
                }
    		},
            onClick:function(){
                this.props.onTileClick(this);
                if(this.state.playerAnswer!==""){
                    this.refs.tileInput.getDOMNode().select();
                }
            },
            onFocus:function(){
            },
    		render:function(){
                var cx = React.addons.classSet;
                var classes = cx({
                    'tile': true,
                    'highlighted': this.props.highlighted,
                    'op-filled': this.state.opAnswer
                });
    			var value = this.state.playerAnswer;
    			return(
    				<div onClick={this.onClick} className={classes}>
    				<span className="gridnum">{this.props.gridnum.gridnum}</span>
    				<div className="letter-holder">
    					<input ref="tileInput" onFocus={this.onFocus} onChange={this.handleChange} maxLength="1" value={value}/>
    				</div>
    				</div>
    			);
    		}
    	});

        socket.on('initPuzzle', function(puz){
       	    React.render(
       	    	<Puzzle puzzle={puz} />,
    	   	    document.getElementById('content')
    	    );
        });
    </script>
</body>
</html>